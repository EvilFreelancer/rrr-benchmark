# Russian Router Ranking (RRR)

Бенчмарк LLM-моделей, оценивающий их способность маршрутизировать/классифицировать текстовые запросы на русском языке.

Этот проект предназначен для автоматизированного тестирования и сравнения моделей больших языковых моделей (LLM) по
задаче маршрутизации диалогов. Модель должна по истории сообщений и списку маршрутов выбрать правильный маршрут (
route_id) и объяснить свой выбор.

## Быстрый старт

1. Установите зависимости:
   ```bash
   pip install -r requirements.txt
   ```
2. Отредактируйте [main.py](./main.py) и в переменной `MODEL_LIST` перечислите список тестируемых моделей (опционально).
3. Запустите тестирование моделей:
   ```bash
   python main.py
   ```
    - Для корректной работы требуется доступ к Ollama-серверу.
4. Результаты сохраняются в CSV-файлы по каждой модели.

## Методология тестирования

Тестирование моделей происходит следующим образом:
- На вход каждой модели подаётся история диалога (messages) и список маршрутов (routes).
- Модель должна выбрать правильный идентификатор маршрута и объяснить свой выбор.
- В ответе ожидается JSON-объект с двумя ключами: reasoning (объяснение) и route_id (целое число).

### Пример входных данных

```json
{
  "messages": [
    {"role": "assistant", "content": "Здравствуйте! Как я могу вам помочь?"},
    {"role": "user", "content": "Где находится ваш офис?"}
  ],
  "routes": [
    {"id": 3519, "sense": "Прекращение диалога в виду неадекватности абонента"},
    {"id": 4630, "sense": "Информация о графике работы организации"},
    {"id": 2198, "sense": "Информация об адресе организации"},
    {"id": 8142, "sense": "Предложение о актуальных акциях и спец предложениях"},
    {"id": 9821, "sense": "Прощание с абонентом после успешного диалога"}
  ],
  "rightStepId": 2198
}
```

## Пример финального запроса к модели

В модель отправляется список сообщений, где первым идёт system prompt с перечислением маршрутов, а далее — история диалога. Пример:

```json
[
  {
    "role": "system",
    "content": "Ты интеллектуальный ассистент для маршрутизации запросов...\n\nМаршруты:\n3519 - Прекращение диалога в виду неадекватности абонента\n4630 - Информация о графике работы организации\n2198 - Информация об адресе организации\n8142 - Предложение о актуальных акциях и спец предложениях\n9821 - Прощание с абонентом после успешного диалога"
  },
  {"role": "assistant", "content": "Здравствуйте! Как я могу вам помочь?"},
  {"role": "user", "content": "Где находится ваш офис?"}
]
```

### Ожидаемый ответ модели

```json
{
   "reasoning": "User asks for the office address, this mean relevant route is about address.", 
   "route_id": 2198
}
```

### Как происходит тестирование
1. Для каждого примера из датасета вызывается модель с соответствующими messages и routes.
2. Модель должна вернуть JSON с reasoning и route_id.
3. route_id сравнивается с правильным (rightStepId). Если совпадает — ответ засчитывается как верный.
4. Считается точность, среднее время ответа и другие метрики.

## Требования

- Python 3.12+
- См. `requirements.txt`

## Датасет для тестирования

Данные, используемые для тестирования моделей, доступны на Hugging
Face: [evilfreelancer/rrr-benchmark](https://huggingface.co/datasets/evilfreelancer/rrr-benchmark)

Скрипт тестирования автоматически загружает этот датасет через библиотеку `datasets`.

> **Внимание:** На данный момент тестирование поддерживает только работу с Ollama. В будущем планируется добавить
> поддержку OpenAI-подобных API (llama.cpp, vLLM, OpenAI, LiteLLM и др.).

## Где найти system prompt

System prompt, используемый для тестирования моделей, находится в файле `structured_router.py` в переменной `SYSTEM_PROMPT`. Он полностью определяет, как модель должна отвечать на задачу маршрутизации.

Пример system prompt (фрагмент):

```
Ты интеллектуальный ассистент для маршрутизации запросов. Твоя задача — проанализировать историю
диалога и входной запрос и определить наиболее подходящий route_id из списка предоставленных маршрутов.
...
ВАЖНО:
- **Не добавляй НИКАКИХ дополнительных полей, комментариев, markdown, html, заголовков, схем.**
- Верни **Только JSON-объект** вида:

{"reasoning": "...", "route_id": N}

- **НЕ ОКРУЖАЙ JSON никакими словами, комментариями, символами.**
...
```
